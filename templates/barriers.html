{% extends "base.html" %}

{% block title %}Barriers - PiBox{% endblock %}

{% block content %}
<div class="page">
    <div class="page-header">
        <h1>Barrier Configuration</h1>
    </div>

    <!-- Relay Controls -->
    <div class="card">
        <div class="card-header section-header">
            <h2>Relay Controls</h2>
            <span class="badge" id="relay-mode-badge"></span>
        </div>
        <div class="card-body">
            <div class="relay-control-grid">
                {% for id, relay in relay_states.items() %}
                <div class="relay-control-card {% if relay.state %}active{% endif %}" id="relay-{{ id }}">
                    <div class="relay-indicator"></div>
                    <div class="relay-number">{{ id }}</div>
                    <div class="relay-label">{{ relay.name }}</div>
                    <div class="relay-btn-group">
                        <button onclick="setRelay({{ id }}, true)" class="btn btn-on">ON</button>
                        <button onclick="setRelay({{ id }}, false)" class="btn btn-off">OFF</button>
                    </div>
                    <button onclick="pulseRelay({{ id }})" class="btn btn-pulse" style="width:100%; margin-top:0.25rem;">PULSE</button>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ANPR Camera Mapping -->
    <div class="card">
        <div class="card-header section-header">
            <h2>ANPR Camera Mapping</h2>
            {% if anpr_cameras %}
            <span class="badge">{{ anpr_cameras|length }} cameras</span>
            {% endif %}
        </div>
        <div class="card-body">
            {% if anpr_cameras %}
            <div class="camera-cards-grid">
                {% for cam in anpr_cameras %}
                <div class="camera-mapping-card {% if cam.relay_list %}configured{% endif %}" id="cam-{{ cam.reg_code }}">
                    <div class="camera-card-header">
                        <div class="camera-card-info">
                            <h3>{{ cam.name or 'Unnamed Camera' }}</h3>
                            <div class="camera-card-meta">
                                <code>{{ cam.reg_code }}</code>
                            </div>
                            {% if cam.location_name %}
                            <div class="camera-card-location">{{ cam.location_name }}</div>
                            {% endif %}
                        </div>
                        <span class="camera-status-badge {% if cam.relay_list %}configured{% else %}unconfigured{% endif %}">
                            {% if cam.relay_list %}
                            R{{ cam.relay_list|join(',') }}
                            {% else %}
                            No relay
                            {% endif %}
                        </span>
                    </div>
                    <div class="camera-card-body">
                        <span class="relay-selector-label">Select relay(s) to trigger:</span>
                        <div class="relay-chips" data-regcode="{{ cam.reg_code }}">
                            {% for i in range(1, 9) %}
                            <div class="relay-chip {% if i in (cam.relay_list or []) %}selected{% endif %}"
                                 data-relay="{{ i }}" onclick="toggleChip(this)">
                                R{{ i }}
                            </div>
                            {% endfor %}
                        </div>
                        <div class="camera-card-actions">
                            <button onclick="saveCamera('{{ cam.reg_code }}')" class="btn btn-primary">Save</button>
                            <button onclick="testCamera('{{ cam.reg_code }}')" class="btn">Test</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-cameras">
                <p><strong>No ANPR cameras found</strong></p>
                <p>Cameras are synced from Odoo. Make sure cameras are configured in Odoo and sync has been performed.</p>
                <a href="/settings" class="btn btn-primary">Go to Settings</a>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Get relay mode on load
    fetch('/api/relay/status')
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const badge = document.getElementById('relay-mode-badge');
                badge.textContent = data.mode === 'web' ? 'Web Relay' : 'GPIO';
                badge.className = 'badge' + (data.mode === 'web' ? ' success' : '');
            }
        });

    function setRelay(channel, state) {
        const action = state ? 'on' : 'off';
        fetch(`/api/relay/${channel}/${action}`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    updateRelayCard(channel, state);
                }
            });
    }

    function pulseRelay(channel) {
        fetch(`/api/relay/${channel}/pulse`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const card = document.getElementById(`relay-${channel}`);
                    card.classList.add('pulsing');
                    card.classList.add('active');
                    setTimeout(() => {
                        card.classList.remove('pulsing');
                        card.classList.remove('active');
                    }, 1500);
                }
            });
    }

    function updateRelayCard(channel, state) {
        const card = document.getElementById(`relay-${channel}`);
        if (state) {
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    }

    // Chip toggle for relay selection
    function toggleChip(chip) {
        chip.classList.toggle('selected');
    }

    function getSelectedRelays(regCode) {
        const container = document.querySelector(`.relay-chips[data-regcode="${regCode}"]`);
        const selected = container.querySelectorAll('.relay-chip.selected');
        return Array.from(selected).map(chip => parseInt(chip.dataset.relay));
    }

    function saveCamera(regCode) {
        const relays = getSelectedRelays(regCode);

        fetch(`/api/anpr-cameras/${regCode}/relay`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ relay_channels: relays })
        })
        .then(r => r.json())
        .then(result => {
            if (result.success) {
                // Update card status
                const card = document.getElementById(`cam-${regCode}`);
                const status = card.querySelector('.camera-status-badge');

                if (relays.length > 0) {
                    card.classList.add('configured');
                    status.className = 'camera-status-badge configured';
                    status.textContent = 'R' + relays.join(',');
                } else {
                    card.classList.remove('configured');
                    status.className = 'camera-status-badge unconfigured';
                    status.textContent = 'No relay';
                }

                showToast(`Saved: ${result.camera_name || regCode}`);
            } else {
                alert('Error: ' + result.error);
            }
        });
    }

    function testCamera(regCode) {
        const relays = getSelectedRelays(regCode);

        if (relays.length === 0) {
            alert('No relays selected. Select at least one relay first.');
            return;
        }

        relays.forEach(channel => {
            fetch(`/api/relay/${channel}/pulse`, { method: 'POST' });
            // Visual feedback on relay card
            const card = document.getElementById(`relay-${channel}`);
            if (card) {
                card.classList.add('pulsing', 'active');
                setTimeout(() => card.classList.remove('pulsing', 'active'), 1500);
            }
        });

        showToast(`Testing R${relays.join(', R')}`);
    }
</script>
{% endblock %}